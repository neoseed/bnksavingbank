name: Convert EUC-KR to UTF-8

on:
  workflow_dispatch:  # ìˆ˜ë™ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥
    inputs:
      branch:
        description: 'Branch to convert'
        required: false
        default: 'main'

jobs:
  convert-encoding:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        ref: ${{ github.event.inputs.branch || 'main' }}
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.x'
    
    - name: Check current encoding
      run: |
        echo "# í˜„ìž¬ íŒŒì¼ ì¸ì½”ë”© í™•ì¸"
        find . -name "*.java" -type f -exec file -i {} \; | head -20
    
    - name: Convert Java files from EUC-KR to UTF-8
      run: |
        echo "# ë³€í™˜ ì‹œìž‘"
        
        # ë³€í™˜ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
        cat > convert.py << 'EOF'
        import os
        import codecs
        import sys
        
        converted = []
        skipped = []
        failed = []
        
        for root, dirs, files in os.walk('.'):
            # .git í´ë” ì œì™¸
            if '.git' in root:
                continue
                
            for file in files:
                if file.endswith('.java'):
                    filepath = os.path.join(root, file)
                    
                    try:
                        # EUC-KRë¡œ ì½ì–´ë³´ê¸°
                        with codecs.open(filepath, 'r', encoding='euc-kr') as f:
                            content = f.read()
                        
                        # UTF-8ë¡œ ì €ìž¥
                        with codecs.open(filepath, 'w', encoding='utf-8') as f:
                            f.write(content)
                        
                        converted.append(filepath)
                        print(f"âœ“ Converted: {filepath}")
                        
                    except UnicodeDecodeError:
                        # ì´ë¯¸ UTF-8ì´ê±°ë‚˜ ë‹¤ë¥¸ ì¸ì½”ë”©
                        skipped.append(filepath)
                        print(f"âŠ Skipped: {filepath} (not EUC-KR)")
                        
                    except Exception as e:
                        failed.append(filepath)
                        print(f"âœ— Failed: {filepath}: {str(e)}")
                        
        print(f"ë³€í™˜ ì™„ë£Œ: {len(converted)}ê°œ")
        print(f"ê±´ë„ˆëœ€: {len(skipped)}ê°œ")
        print(f"ì‹¤íŒ¨: {len(failed)}ê°œ")
        EOF
        
        python convert.py
    
    - name: Check encoding after conversion
      run: |
        echo "# ë³€í™˜ í›„ ì¸ì½”ë”© í™•ì¸"
        find . -name "*.java" -type f -exec file -i {} \; | head -20
    
    - name: Configure Git
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
    
    - name: Commit and Push changes
      run: |
        git add -A
        if git diff --staged --quiet; then
          echo "# ë³€í™˜í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        else
          git commit -m "ðŸ”„ Convert Java files from EUC-KR to UTF-8
          
          - Automated encoding conversion
          - Changed files: $(git diff --staged --name-only | wc -l) files"
          
          git push
        fi
    
    - name: Summary
      run: |
        echo "# ì¸ì½”ë”© ë³€í™˜ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# ë³€ê²½ëœ íŒŒì¼ ëª©ë¡:" >> $GITHUB_STEP_SUMMARY
        git diff --name-only HEAD~1 >> $GITHUB_STEP_SUMMARY || echo "No changes" >> $GITHUB_STEP_SUMMARY
